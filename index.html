<!DOCTYPE HTML>
<html>
<head>
<style>


.debug {
position:absolute;
display:none;
left:300px;
top:0px;
font-family:tahoma;
font-size:14px;
color:#ffffff;
}

.debug * {
height:18px;
line-height:18px;
}

.debug font {
display:inline-block;
width:50px;
text-align:right;
vertical-align:top;
}

.debug span {
display:inline-block;
width:50px;
text-align:right;
vertical-align:top;
}

</style>
</head>
<body style="margin:0px;overflow:hidden;background:#8A7E9B;">


<div id="project">


<table id="debug" class="debug" cellpadding="0px" cellspacing="0px">
<tr><td>Âñåãî îáúåêòîâ:</td><td id="tris"></td></tr>
<tr><td>Îáúåêòû ãîğîäà:</td><td id="town"></td></tr>
<tr><td>Äîáàâëåíèå ñíåãà:</td><td id="snow_add"></td></tr>
<tr><td>Ïàäåíèå ñíåãà:</td><td id="snow_fall"></td></tr>
<tr><td>Óâÿäàíèå ñíåãà:</td><td id="snow_fade"></td></tr>
<tr><td>Àíèìàöèè:</td><td id="animations"></td></tr>
<tr><td>Javascript:</td><td id="javascript"></td></tr>
<tr><td>Ğåíäåğåğ:</td><td id="renderer"></td></tr>
<tr><td>Îòğèñîâêà êàäğà:</td><td id="frame"></td></tr>
</table>


<div id="loading" style="position:absolute;display:block;top:50%;width:100%;text-align:center;font-family:arial;font-size:40px;color:#ffffff;text-shadow:1px 1px 4px #393342;">ÇÀÃĞÓÆÅÍÎ <span id="loading_amount"></span></div>
<div id="begin" onclick="this.style.display='none';last();" style="cursor:pointer;position:absolute;display:none;top:50%;width:100%;text-align:center;font-family:arial;font-size:40px;color:#ffffff;text-shadow:1px 1px 4px #393342;">ÑÒÀĞÒ</div>
<canvas id="canvas" width="800" height="600" style="background:#8A7E9B;vertical-align:top;"></canvas>
</div>


<audio id="music" preload>
<source src="sounds/silent_hill.mp3" type="audio/mpeg">
</audio>


<script type="text/javascript">
var vs=[]; // ÂÅĞÒÅÊÑÍÛÉ ØÅÉÄÅĞ
var fs=[]; // ÔĞÀÃÌÅÍÒÍÛÉ ØÅÉÄÅĞ
</script>


<script type="text/javascript" src="js_ru/libs/three_132.js"></script>
<script type="text/javascript" src="js_ru/libs/SkeletonUtils.js"></script>
<script type="text/javascript" src="js_ru/libs/FirstPersonControls.js"></script>
<script type="text/javascript" src="js_ru/libs/fflate.min.js"></script>
<script type="text/javascript" src="js_ru/intersection_ray_triangle.js"></script>
<script type="text/javascript" src="js_ru/cell.js"></script>
<script type="text/javascript" src="js_ru/stats.js"></script>
<script type="text/javascript" src="js_ru/OBJLoader.js"></script>
<script type="text/javascript" src="js_ru/init.js"></script>
<script type="text/javascript" src="js_ru/lights.js"></script>
<script type="text/javascript" src="js_ru/sounds.js"></script>
<script type="text/javascript" src="js_ru/loader.js"></script>
<script type="text/javascript" src="js_ru/renderer_stats.js"></script>
<script type="text/javascript" src="js_ru/FBXLoader.js"></script>


<script type="text/javascript">


"use strict";


var slow_down=0;
var slow_up=0;
var slow_v=0.016;


//____________________ ÑÒÀÒÈÑÒÈÊÀ ____________________


var debug_mode=true; // false - ÍÅ ÎÒÎÁĞÀÆÀÒÜ ÑÒÀÒÈÑÒÈÊÓ, true - ÎÒÎÁĞÀÆÀÒÜ
var debug_frame=true; // false - ÍÅ ÎÒÎÁĞÀÆÀÒÜ ÑÒÀÒÈÑÒÈÊÓ JAVASCRIPT, ĞÅÍÄÅĞÅĞÀ È ÎÒĞÈÑÎÂÊÈ ÊÀÄĞÀ, true - ÎÒÎÁĞÀÆÀÒÜ
var debug_max_min=5; // Ñ ÊÀÊÈÌ ÈÍÒÅĞÂÀËÎÌ Â ÑÅÊÓÍÄÀÕ, ÎÁÍÎÂËßÒÜ ÌÀÊÑÈÌÀËÜÍÎÅ È ÌÈÍÈÌÀËÜÍÎÅ ÇÀÒĞÀ×ÅÍÍÎÅ ÂĞÅÌß
var debug_now=0.2; // Ñ ÊÀÊÈÌ ÈÍÒÅĞÂÀËÎÌ Â ÑÅÊÓÍÄÀÕ, ÎÁÍÎÂËßÒÜ ÒÅÊÓÙÅÅ ÇÀÒĞÀ×ÅÍÍÎÅ ÂĞÅÌß
var debug_text=[];
var debug_fps_elapsed=0;
var debug_fps_now=0;
var debug_fps_last=0;


var debug=[]; // ÌÀÑÑÈÂ ÄËß ÑÒÀÒÈÑÒÈÊÈ ÇÀÒĞÀ×ÅÍÍÎÃÎ ÂĞÅÌÅÍÈ


if(!debug_mode){
var item=document.getElementById("debug").getElementsByTagName("tr");
var max=item.length;
for(var n=0;n<item.length;n++){
var html=item[n].innerHTML;
if(!html.match(/javascript/g) && !html.match(/renderer/g) && !html.match(/frame/g)){
item[n].remove();
n--;
}
}
}


if(!debug_frame){
var item=document.getElementById("debug").getElementsByTagName("tr");
var max=item.length;
for(var n=0;n<item.length;n++){
var html=item[n].innerHTML;
if(html.match(/javascript/g) || html.match(/renderer/g) || html.match(/frame/g)){
item[n].remove();
n--;
}
}
}


if(debug_mode || debug_frame){ document.getElementById("debug").style.display="table"; }


function debug_set(name){
debug[name]={};
debug[name].element=document.getElementById(name);
debug[name].end;
debug[name].elapsed_now=0;
debug[name].elapsed_max_min=0;
debug[name].max=0;
debug[name].min=100;
debug[name].now=0;
}


function debug_calc(name,arg){
var item=debug[name];
var end=Number((performance.now()-item.start).toFixed(3));
var frame=0;
if(name=="javascript" || name=="renderer" || name=="frame"){ frame=1; }
if(!debug_frame && frame==1){ return; }
if(!debug_mode && frame==0){ return; }
if(end>item.max){ item.max=end; }
if(end<item.min){ item.min=end; }
item.elapsed_max_min+=delta;
item.elapsed_now+=delta;
if(item.elapsed_max_min>debug_max_min){ item.elapsed_max_min=0; item.max=0.001; item.min=100; }
if(item.elapsed_now>debug_now){ item.elapsed_now=0; item.now=end; }
if(arg!=null){ var text="<font>["+arg+"]</font> "; }
else{ var text="<font></font> "; }
text+="max: <span>"+item.max.toFixed(3)+"</span> min: <span>"+item.min.toFixed(3)+"</span> now: <span>"+item.now.toFixed(3)+"</span>";
debug_text.push([name,text]);
}


debug_set("snow_add");
debug_set("snow_fall");
debug_set("snow_fade");
debug_set("animations");
debug_set("javascript");
debug_set("renderer");
debug_set("frame");


var canvas=document.getElementById("canvas");
var sens=1.5; // ×ÓÂÑÒÂÈÒÅËÜÍÎÑÒÜ ÏÎÂÎĞÎÒÀ Â ÏÎËÍÎİÊĞÀÍÍÎÌ ĞÅÆÈÌÅ


var ways_9=[[-1,-1],[0,-1],[1,-1],[-1,0],[0,0],[1,0],[-1,1],[0,1],[1,1]];


var objects_list=[];
var town_cell_size=20;
var town_tris_size=1;


var camera_bottom=-0.5;
var camera_min_height=1;
var camera_max_height=2;
var camera_top=3;


var camera_town_x=-500;
var camera_town_z=-500;
var camera_town_pre_x=0;
var camera_town_pre_z=0;


var canvas_width=screen.width;
var canvas_height=screen.height;
canvas.width=canvas_width;
canvas.height=canvas_height;
var canvas_half_width=canvas_width/2;
var canvas_half_height=canvas_height/2;


var renderer_PixelRatio=window.devicePixelRatio;
var stop=1; // ÑÒÎÏ È ÇÀÏÓÑÊ ÔÓÍÊÖÈÈ loop();
var mouse=0;


var OBJLoader=new THREE.OBJLoader();
var FBXLoader=new THREE.FBXLoader();


if(debug_mode){
var stats=new Stats();
document.getElementById("project").appendChild(stats.dom);


document.getElementById("project").appendChild(renderer_stats_canvas);
}


var mat=[];
var mesh=[];
var mixers=[];
var mixer=[];
var action=[];
var clock=new THREE.Clock();
clock.autoStart=true;
var delta=0;
var trigger=[];


var origin_x=0;
var origin_y=0;
var origin_z=0;
var direction_x=0;
var direction_y=0;
var direction_z=0;
var distance=0;


var direction_2d_x=0;
var direction_2d_z=0;


var intersection_cell="";
var intersection_tris=[];


//var camera=new THREE.PerspectiveCamera(60,canvas_width/canvas_height,0.1,20);
var camera=new THREE.PerspectiveCamera(60,canvas_width/canvas_height,0.1,20000);
camera.position.set(185,camera_min_height,-235);


var camera_position=camera.position;


var scene_hud=new THREE.Scene();
var camera_hud=new THREE.OrthographicCamera(canvas_width/-2,canvas_width/2,canvas_height/2,canvas_height/-2,-1,1000000);
// ÎÒÎÄÂÈÃÀÅÌ ÏÎ Z, ×ÒÎÁÛ ËŞÁÛÅ ÄÀËÜÍÈÅ ÎÁÚÅÊÒÛ ÏÎÏÀËÈ Â ÏÎËÅ ÇĞÅÍÈß
camera_hud.position.z=100000;


var renderer=new THREE.WebGLRenderer({canvas:canvas,antialias:true,alpha:true,transparent:true,premultipliedAlpha:true,physicallyCorrectLights:false,logarithmicDepthBuffer:false});
renderer.setSize(canvas_width,canvas_height);
renderer.setPixelRatio(renderer_PixelRatio);
renderer.setClearColor(0xffffff);
renderer.autoClear=false;
renderer.shadowMap.enabled=false;
renderer.shadowMap.type=0;


var controls=new THREE.FirstPersonControls(camera,renderer.domElement);
controls.movementSpeed=4;
controls.lookSpeed=0.1;
controls.lookVertical=true;
controls.lon=-1.5*180/Math.PI;


var scene=new THREE.Scene();
var scene_children=scene.children;


if(debug_mode){
mesh["grid_20"]=new THREE.GridHelper(800,40,0x0000ff,0x00ff00);
mesh["grid_20"].position.set(0,-1,0);
scene.add(mesh["grid_20"]);
}


//____________________ ÒÅÊÑÒÓĞÛ ____________________


var maxanisotropy=renderer.capabilities.getMaxAnisotropy(); // ×ÅÒÊÎÑÒÜ ÈÇÎÁĞÀÆÅÍÈß


var tex=[];
var texture_loader=new THREE.TextureLoader(loadingManager);


tex["logo_text"]=texture_loader.load("images/logo_text.png");
tex["logo_end"]=texture_loader.load("images/logo_end.png");
tex["logo_noise"]=texture_loader.load("images/logo_noise.jpg");
tex["snow"]=texture_loader.load("images/snow.png");


tex["Harry_Mason"]=texture_loader.load("models/Harry_Mason/Harry_Mason.png");
tex["Cheryl_Mason"]=texture_loader.load("models/Cheryl_Mason/Cheryl_Mason.png");
tex["air_screamer"]=texture_loader.load("models/air_screamer/air_screamer.png");
tex["groaner"]=texture_loader.load("models/groaner/groaner.png");
tex["mumbler"]=texture_loader.load("models/mumbler/mumbler.png");


var images=["AMBCARH","SPR01F","SPR02F","SPR03F","SPR04F","SPR04H","SPR05F","SPR06F","SPR07F","SPR07H","SPR08F","SPR08H","SPR09F","SPR10F","SPR11F",
"SPR12F","SPR13F","SPR14F","SPR15F","SPR15H","SPR16F","SPR17F","SPR18F","SPR19F","SPR21F","SPR24F","SPR25F","SPR25H","SPR26F","SPR27F","SPRG1F",
"SPRG2F","SPRG3F","SPRG4F","THR0001F","THR0002F","THR0003F","THR0004F","THR0201F","THR0301F","THR0401F","THR0501F","THR0601F","THR0701F","THR0702H",
"THR0801F","THR0901F","THR1001F","THR1101F","THR1102H","THR1201F","THR1202H","THR1301F","THR1401F","THR1501F","THR1601F","THR1701F","THR1801F",
"THR1901F","THR2001F","THR2101F","THR2102H","THR2201F","THR2301F","THR2301H","THR2401F","THR2501F","THR2601F","THR2701F","THR2801F","THR2901F",
"THR3001F","THR3101F","THR3102H","THR3201F","THR3301F","THR3401F","THR3401H","THR3501F","THR3501H","THR3601F","THR3701F","THR3801F","THR3801H",
"THR3901F","THR4001F","THR4101F","THR4301F","THR4401F","THR4401H","THR4501F","THR4601F","THR4701F","THR4801F","THR4802H","THR5001F","THR5001H",
"THR5101F","THR5201F","THR5301F","THR5401F","THR5402H","THR5701F","THR5702H","THR5801F","THR5802H","THR5901F","THR6001F","THR6002H","THR6101F",
"THR6201F","THR6401F","THR6402H","THR6501F","THR6601F","THR6602H","THR6701F","THR6801F","THR6801H","THR6901F","THR6901H","THR7001F","THR7001H",
"THR7101F","THR7101H","THR7201F","THR7201H","THR7301F","THR7401F","THR7401H","THR7501F","THR7601F","THR7602H","THR7701F","THR7801F","THR7901F",
"THR7902H","THR8001F","THR8101F","THR8201F","THR8301F","THR8401F","THR8501F","THR8601F","THR9001F","THR9002H","THR9101F","THR9401F","THR9401H",
"THR9501F","THR9601F","THR9701F","THR9801F","THR9901F","THRA001F","THRA101F","THRA102H","THRA201F","THRA301F","THRA301H","THRA401F","THRA401H",
"THRA501F","THRA601F","THRA601H","THRA701F","THRA801F","THRA801H","THRA901F","THRB101F","THRB102H","THRB401F","THRB501F","THRB502H","THRB601F","THRB701F","THRC101F"];


for(var n=0;n<images.length;n++){
tex[images[n]]=texture_loader.load("models/town/images/"+images[n]+".png");
// ÄËß ÏÈÊÑÅËÜÍÎÑÒÈ ÒÅÊÑÒÓĞ ÊÀÊ Â PLAYSTATION
//tex[images[n]].magFilter=THREE.NearestFilter;
//tex[images[n]].minFilter=THREE.LinearMipMapLinearFilter;
}


for(var n in tex){
manager_to_load++; // ÏÎÄÑ×ÈÒÛÂÀÅÌ ÊÎËÈ×ÅÑÒÂÎ ÒÅÊÑÒÓĞ ÄËß ÇÀÃĞÓÇÊÈ
}


//____________________ ÍÅÁÎ ____________________


scene.background=new THREE.Color(0x8A7E9B);


for(var n=0;n<images.length;n++){
mat[images[n]]=new THREE.MeshStandardMaterial({
map:tex[images[n]],
alphaTest:0.98,
});
}


//____________________ ËÎÃÎÒÈÏ ____________________


vs["logo"]=`


varying vec2 vUv;


void main(){
vUv=uv;
gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);
}`;


fs["logo"]=`


varying vec2 vUv;
uniform sampler2D map;
uniform sampler2D noise;
uniform float alpha;
uniform float size;
uniform float dissolve;
uniform vec3 color;


void main(){


vec4 diffuse=texture2D(map,vUv);
float n=texture2D(noise,vUv).x-dissolve;
if(n<0.0){ discard; }
if(n<size){ diffuse.rgb=color; }
gl_FragColor=diffuse;
gl_FragColor.a*=alpha;


}`;


mat["logo"]=new THREE.ShaderMaterial({
uniforms:{
map:{value:tex["logo_text"]},
noise:{value:tex["logo_noise"]},
alpha:{value:0},
size:{value:0.02},
dissolve:{value:0},
color:{value:new THREE.Color(0xffffff)}
},
vertexShader:vs["logo"],
fragmentShader:fs["logo"],
transparent:true,
depthTest:false,
depthWrite:false,
});


mesh["logo"]=new THREE.Mesh(new THREE.PlaneBufferGeometry(1.024,0.256,1),mat["logo"]);


mesh["logo"].frustumCulled=false;
mesh["logo"].position.z=-0.7;
mesh["logo"].updateMatrix();
mesh["logo"].matrixAutoUpdate=false;
mesh["logo"].updateMatrixWorld=function(){};
mesh["logo"].renderOrder=-1;
scene.add(mesh["logo"]);


var logo_status=[];
var logo_status_n=0;
var logo_timer=0;


logo_status[0]=function(){}


logo_status[1]=function(){
logo_timer+=delta;
if(logo_timer>7){
snow_add_m=1;
logo_status_n=2;
logo_timer=0;
}
}


logo_status[2]=function(){
logo_timer+=delta;
if(logo_timer>2){
document.getElementById('music').play();
logo_timer=0;
logo_status_n=3;
}
}


logo_status[3]=function(){
logo_timer+=delta;
if(logo_timer>4){
logo_timer=0;
logo_status_n=4;
}
}


logo_status[4]=function(){
mesh["logo"].material.uniforms.alpha.value+=delta/40;
if(mesh["logo"].material.uniforms.alpha.value>=0.2){
mesh["logo"].material.uniforms.alpha.value=0.2;
logo_status_n=5;
}
}


logo_status[5]=function(){
logo_timer+=delta;
if(logo_timer>4){
logo_timer=0;
logo_status_n=6;
}
}


logo_status[6]=function(){
mesh["logo"].material.uniforms.dissolve.value+=delta/3;
if(mesh["logo"].material.uniforms.dissolve.value>=1){
mesh["logo"].material.uniforms.dissolve.value=1;
mesh["logo"].material.uniforms.map.value=tex["logo_end"];
mesh["logo"].position.x=-100;
mesh["logo"].updateMatrix();
logo_status_n=7;
}
}


logo_status[7]=function(){
logo_timer+=delta;
if(logo_timer>0.5){
logo_timer=0;
logo_status_n=8;
}
}


logo_status[8]=function(){
scene.fog.density-=delta;
if(scene.fog.density<=0.14){
scene.fog.density=0.14;
logo_status_n=9;
mouse=1;
go=1;
clock.start();
}
}


logo_status[9]=function(){
logo_timer+=delta;
if(logo_timer>130){
logo_timer=0;
mesh["logo"].position.x=0;
mesh["logo"].updateMatrix();
mesh["logo"].material.uniforms.alpha.value=0;
mesh["logo"].material.uniforms.dissolve.value=0;
logo_status_n=10;
}
}


logo_status[10]=function(){
scene.fog.density+=delta/4;
if(scene.fog.density>=2){
scene.fog.density=2;
}
mesh["logo"].material.uniforms.alpha.value+=delta/60;
if(mesh["logo"].material.uniforms.alpha.value>=0.2){
mesh["logo"].material.uniforms.alpha.value=0.2;
}
if(scene.fog.density>=2 && mesh["logo"].material.uniforms.alpha.value>=0.2){
snow_add_m=0;
logo_status_n=11;
}
}


logo_status[11]=function(){
mesh["logo"].material.uniforms.dissolve.value+=delta/3;
if(mesh["logo"].material.uniforms.dissolve.value>=1){
mesh["logo"].material.uniforms.dissolve.value=1;
mesh["logo"].material.uniforms.map.value=tex["logo_end"];
logo_status_n=0;
}
}


function last(){
fullscreen();
canvas.requestPointerLock();
logo_status_n=1;
}


// ____________________ HARRY MASON ____________________


other_to_load++;
FBXLoader.load('models/Harry_Mason/Harry_Mason.fbx',function(object){
mixer["Harry_Mason"]=new THREE.AnimationMixer(object);
action["Harry_Mason"]=THREE.AnimationUtils.subclip(object.animations[0],'run',2,500);
action["Harry_Mason"]=mixer["Harry_Mason"].clipAction(action["Harry_Mason"]);
action["Harry_Mason"].play();
mixers.push(mixer["Harry_Mason"]);
mesh["Harry_Mason"]=object;
mesh["Harry_Mason"].children[1].material=new THREE.MeshBasicMaterial({map:tex["Harry_Mason"]});
mesh["Harry_Mason"].children[1].frustumCulled=false;
mesh["Harry_Mason"].position.set(188.5,-0.58,-240);
mesh["Harry_Mason"].scale.set(0.05,0.05,0.05);
// ÑÊĞÛÂÀÅÌ ÊÎÑÒÈ, ÑÍÈÆÀß ÍÀÃĞÓÇÊÓ ÍÀ 10%. ÏĞÈ İÒÎÌ ÄÎÑÒÀÒÎ×ÍÎ ÑÊĞÛÒÜ ÏÅĞÂÓŞ ÎÑÍÎÂÓÍÓŞ ÊÎÑÒÜ, ÎÑÒÀËÜÍÛÅ ÍÅÎÁßÇÀÒÅËÜÍÎ.
mesh["Harry_Mason"].traverse(function(child){
if(child.isBone){ child.visible=false; }
});
action["Harry_Mason"]._loopCount=0;
mesh["Harry_Mason"].distance=3;
scene.add(mesh["Harry_Mason"]);
other_loaded++;
});


// ____________________ CHERYL MASON ____________________


other_to_load++;
FBXLoader.load('models/Cheryl_Mason/Cheryl_Mason.fbx',function(object){
mixer["Cheryl_Mason"]=new THREE.AnimationMixer(object);
action["Cheryl_Mason"]=THREE.AnimationUtils.subclip(object.animations[0],'idle',0,1000);
action["Cheryl_Mason"]=mixer["Cheryl_Mason"].clipAction(action["Cheryl_Mason"]);
action["Cheryl_Mason"].timeScale=0.5;
action["Cheryl_Mason"].play();
mixers.push(mixer["Cheryl_Mason"]);
mesh["Cheryl_Mason"]=object;
mesh["Cheryl_Mason"].children[0].material=new THREE.MeshBasicMaterial({map:tex["Cheryl_Mason"]});
mesh["Cheryl_Mason"].children[0].frustumCulled=false;
mesh["Cheryl_Mason"].children[0].onAfterRender=function(){
this.frustumCulled=true;
this.onAfterRender=function(){};
}
mesh["Cheryl_Mason"].position.set(165.5,-0.65,-167.7);
mesh["Cheryl_Mason"].rotation.y=-0.88
mesh["Cheryl_Mason"].scale.set(0.04,0.04,0.04);
// ÑÊĞÛÂÀÅÌ ÊÎÑÒÈ, ÑÍÈÆÀß ÍÀÃĞÓÇÊÓ ÍÀ 10%. ÏĞÈ İÒÎÌ ÄÎÑÒÀÒÎ×ÍÎ ÑÊĞÛÒÜ ÏÅĞÂÓŞ ÎÑÍÎÂÓÍÓŞ ÊÎÑÒÜ, ÎÑÒÀËÜÍÛÅ ÍÅÎÁßÇÀÒÅËÜÍÎ.
mesh["Cheryl_Mason"].traverse(function(child){
if(child.isBone){ child.visible=false; }
});
scene.add(mesh["Cheryl_Mason"]);
other_loaded++;
});


// ____________________ AIR SCREAMER ____________________


other_to_load++;
FBXLoader.load('models/air_screamer/air_screamer.fbx',function(object){
mixer["air_screamer"]=new THREE.AnimationMixer(object);
action["air_screamer"]=THREE.AnimationUtils.subclip(object.animations[0],'fly',0,1000);
action["air_screamer"]=mixer["air_screamer"].clipAction(action["air_screamer"]);
action["air_screamer"].timeScale=0.5;
action["air_screamer"].play();
mixers.push(mixer["air_screamer"]);
mesh["air_screamer"]=object;
mesh["air_screamer"].children[4].material=new THREE.MeshBasicMaterial({map:tex["air_screamer"]});
mesh["air_screamer"].children[4].frustumCulled=false;
mesh["air_screamer"].children[4].onAfterRender=function(){
this.frustumCulled=true;
this.onAfterRender=function(){};
}
mesh["air_screamer"].position.set(47,-2,-165);
mesh["air_screamer"].rotation.y=1.57;
mesh["air_screamer"].scale.set(0.012,0.012,0.012);
// ÑÊĞÛÂÀÅÌ ÊÎÑÒÈ, ÑÍÈÆÀß ÍÀÃĞÓÇÊÓ ÍÀ 10%. ÏĞÈ İÒÎÌ ÄÎÑÒÀÒÎ×ÍÎ ÑÊĞÛÒÜ ÏÅĞÂÓŞ ÎÑÍÎÂÓÍÓŞ ÊÎÑÒÜ, ÎÑÒÀËÜÍÛÅ ÍÅÎÁßÇÀÒÅËÜÍÎ.
mesh["air_screamer"].traverse(function(child){
if(child.isBone){ child.visible=false; }
});
scene.add(mesh["air_screamer"]);
other_loaded++;
});


trigger["air_screamer"]=new THREE.Mesh(new THREE.BoxBufferGeometry(10,5,26),new THREE.MeshBasicMaterial({color:0xffff00}));
trigger["air_screamer"].geometry.computeBoundingBox();
trigger["air_screamer"].material.wireframe=true;
trigger["air_screamer"].position.set(58,1.5,-160);
if(debug_mode){
scene.add(trigger["air_screamer"]);
}
var min=trigger["air_screamer"].geometry.boundingBox.min;
var max=trigger["air_screamer"].geometry.boundingBox.max;
var position=trigger["air_screamer"].position;
min.x+=position.x;
min.y+=position.y;
min.z+=position.z;
max.x+=position.x;
max.y+=position.y;
max.z+=position.z;
trigger["air_screamer"].min_x=min.x;
trigger["air_screamer"].min_y=min.y;
trigger["air_screamer"].min_z=min.z;
trigger["air_screamer"].max_x=max.x;
trigger["air_screamer"].max_y=max.y;
trigger["air_screamer"].max_z=max.z;
trigger["air_screamer"].activated=0;


// ____________________ GROANER ____________________


mat["groaner"]=new THREE.MeshLambertMaterial({map:tex["groaner"]});


other_to_load++;
FBXLoader.load('models/groaner/groaner.fbx',function(object){


mesh["groaner"]=object;
// ÍÀÇÍÀ×ÀÅÌ ÌÀÒÅĞÈÀË ÎÒÄÅËÜÍÎ, ×ÒÎÁÛ ÏÎÒÎÌ ÌÎÆÍÎ ÁÛËÎ ÅÃÎ ÌÅÍßÒÜ ÑĞÀÇÓ ÍÀ ÂÑÅÕ ÎÁÚÅÊÒÀÕ
// ÊÎËÈ×ÅÑÒÂÎ ÒÅÊÑÒÓĞ ÓÂÅËÈ×ÈÂÀÅÒÑß Â ÑÒÀÒÈÑÒÈÊÅ ĞÅÍÄÅĞÈÍÃÀ, ÍÎ ÍÀ ÏÀÌßÒÈ İÒÎ ÍÈÊÀÊ ÍÅ ÎÒĞÀÆÀÅÒÑß,
// Ò.Ê. Â ÏÀÌßÒÈ ÕĞÀÍÈÒÑß ÂÑÅÃÎ ÎÄÍÀ ÒÅÊÑÒÓĞÀ, À ÎÑÒÀËÜÍÎÅ İÒÎ ÑÑÛËÊÈ ÍÀ ÍÅ¨
// ÅÑËÈ ÍÓÆÅÍ ĞÀÇÍÛÉ ÌÀÒÅĞÈÀË, ÒÎ ÄËß ÊÀÆÄÎÃÎ ÍÀÄÎ ÑÎÇÄÀÂÀÒÜ ÍÎÂÛÉ ÌÀÒÅĞÈÀË Ñ ÍÓÆÍÛÌÈ ÑÂÀÎÉÑÒÂÀÌÈ
// ÅÑËÈ Â ÍÎÂÎÌ ÌÀÒÅĞÈÀËÅ ÁÓÄÅÒ ÒÀÆÅ ÒÅÊÑÒÓĞÀ, ÒÎ ÒÎÆÅ ÍÅ ÇÀÉÌ¨Ò ÏÀÌßÒÜ, À ÒÎËÜÊÎ ÓÂÅËÈ×ÈÒÑß ÊÎËÈ×ÅÑÒÂÎ ÒÅÊÑÒÓĞ Â ÑÒÀÒÈÑÒÈÊÅ ĞÅÍÄÅĞÈÍÃÀ
mesh["groaner"].children[1].material=mat["groaner"];


// ÑÊĞÛÂÀÅÌ ÊÎÑÒÈ, ÑÍÈÆÀß ÍÀÃĞÓÇÊÓ ÍÀ 10%. ÏĞÈ İÒÎÌ ÄÎÑÒÀÒÎ×ÍÎ ÑÊĞÛÒÜ ÏÅĞÂÓŞ ÎÑÍÎÂÓÍÓŞ ÊÎÑÒÜ, ÎÑÒÀËÜÍÛÅ ÍÅÎÁßÇÀÒÅËÜÍÎ.
mesh["groaner"].traverse(function(child){
if(child.isBone){ child.visible=false; }
});


mesh["groaner_jump_and_run"]=THREE.SkeletonUtils.clone(mesh["groaner"]);
mesh["groaner_jump_and_run"].animations=mesh["groaner"].animations;
mixer["groaner_jump_and_run"]=new THREE.AnimationMixer(mesh["groaner_jump_and_run"]);
action["groaner_jump"]=THREE.AnimationUtils.subclip(mesh["groaner_jump_and_run"].animations[0],'jump',124,152);
action["groaner_jump"]=mixer["groaner_jump_and_run"].clipAction(action["groaner_jump"]);
action["groaner_run"]=THREE.AnimationUtils.subclip(mesh["groaner_jump_and_run"].animations[0],'run',153,173);
action["groaner_run"]=mixer["groaner_jump_and_run"].clipAction(action["groaner_run"]);
action["groaner_run"].play();
mixers.push(mixer["groaner_jump_and_run"]);
mesh["groaner_jump_and_run"].animations=[];
mesh["groaner_jump_and_run"].scale.set(0.02,0.02,0.02);
mesh["groaner_jump_and_run"].position.set(56,-1.2,-80);
mesh["groaner_jump_and_run"].rotation.y=3.14;
scene.add(mesh["groaner_jump_and_run"]);


mesh["groaner_attack_1"]=THREE.SkeletonUtils.clone(mesh["groaner"]);
mesh["groaner_attack_1"].animations=mesh["groaner"].animations;
mixer["groaner_attack_1"]=new THREE.AnimationMixer(mesh["groaner_attack_1"]);
action["groaner_attack_1"]=THREE.AnimationUtils.subclip(mesh["groaner_attack_1"].animations[0],'attack',0,123);
action["groaner_attack_1"]=mixer["groaner_attack_1"].clipAction(action["groaner_attack_1"]);
//action["groaner_attack_1"].time=Math.random()*action["groaner_attack_1"]._clip.duration;
action["groaner_attack_1"].time=0;
action["groaner_attack_1"].play();
mixers.push(mixer["groaner_attack_1"]);
mesh["groaner_attack_1"].animations=[];
mesh["groaner_attack_1"].scale.set(0.02,0.02,0.02);
mesh["groaner_attack_1"].position.set(133.5,-1.3,-8.5);
mesh["groaner_attack_1"].rotation.y=-0.35;
mesh["groaner_attack_1"].children[1].frustumCulled=false;
mesh["groaner_attack_1"].children[1].onAfterRender=function(){
this.frustumCulled=true;
this.onAfterRender=function(){};
}
scene.add(mesh["groaner_attack_1"]);


mesh["groaner_attack_2"]=THREE.SkeletonUtils.clone(mesh["groaner"]);
mesh["groaner_attack_2"].animations=mesh["groaner"].animations;
mixer["groaner_attack_2"]=new THREE.AnimationMixer(mesh["groaner_attack_2"]);
action["groaner_attack_2"]=THREE.AnimationUtils.subclip(mesh["groaner_attack_2"].animations[0],'attack',0,123);
action["groaner_attack_2"]=mixer["groaner_attack_2"].clipAction(action["groaner_attack_2"]);
//action["groaner_attack_2"].time=Math.random()*action["groaner_attack_2"]._clip.duration;
action["groaner_attack_2"].time=1.5;
action["groaner_attack_2"].play();
mixers.push(mixer["groaner_attack_2"]);
mesh["groaner_attack_2"].animations=[];
mesh["groaner_attack_2"].scale.set(0.02,0.02,0.02);
mesh["groaner_attack_2"].position.set(132.5,-1.3,-8.5);
mesh["groaner_attack_2"].rotation.y=0.35;
mesh["groaner_attack_2"].children[1].frustumCulled=false;
mesh["groaner_attack_2"].children[1].onAfterRender=function(){
this.frustumCulled=true;
this.onAfterRender=function(){};
}
scene.add(mesh["groaner_attack_2"]);


mesh["groaner_attack_3"]=THREE.SkeletonUtils.clone(mesh["groaner"]);
mesh["groaner_attack_3"].animations=mesh["groaner"].animations;
mixer["groaner_attack_3"]=new THREE.AnimationMixer(mesh["groaner_attack_3"]);
action["groaner_attack_3"]=THREE.AnimationUtils.subclip(mesh["groaner_attack_3"].animations[0],'attack',0,123);
action["groaner_attack_3"]=mixer["groaner_attack_3"].clipAction(action["groaner_attack_3"]);
//action["groaner_attack_3"].time=Math.random()*action["groaner_attack_3"]._clip.duration;
action["groaner_attack_3"].time=3;
action["groaner_attack_3"].play();
mixers.push(mixer["groaner_attack_3"]);
mesh["groaner_attack_3"].animations=[];
mesh["groaner_attack_3"].scale.set(0.02,0.02,0.02);
mesh["groaner_attack_3"].position.set(134.5,-1.3,-7.5);
mesh["groaner_attack_3"].rotation.y=-1.4;
mesh["groaner_attack_3"].children[1].frustumCulled=false;
mesh["groaner_attack_3"].children[1].onAfterRender=function(){
this.frustumCulled=true;
this.onAfterRender=function(){};
}
scene.add(mesh["groaner_attack_3"]);


mesh["groaner_attack_4"]=THREE.SkeletonUtils.clone(mesh["groaner"]);
mesh["groaner_attack_4"].animations=mesh["groaner"].animations;
mixer["groaner_attack_4"]=new THREE.AnimationMixer(mesh["groaner_attack_4"]);
action["groaner_attack_4"]=THREE.AnimationUtils.subclip(mesh["groaner_attack_4"].animations[0],'attack',0,123);
action["groaner_attack_4"]=mixer["groaner_attack_4"].clipAction(action["groaner_attack_4"]);
//action["groaner_attack_4"].time=Math.random()*action["groaner_attack_4"]._clip.duration;
action["groaner_attack_4"].time=3.6;
action["groaner_attack_4"].play();
mixers.push(mixer["groaner_attack_4"]);
mesh["groaner_attack_4"].animations=[];
mesh["groaner_attack_4"].scale.set(0.02,0.02,0.02);
mesh["groaner_attack_4"].position.set(131.8,-1.3,-7.5);
mesh["groaner_attack_4"].rotation.y=1.4;
mesh["groaner_attack_4"].children[1].frustumCulled=false;
mesh["groaner_attack_4"].children[1].onAfterRender=function(){
this.frustumCulled=true;
this.onAfterRender=function(){};
}
scene.add(mesh["groaner_attack_4"]);


other_loaded++;
});


var groaner_jar_status=[];
var groaner_jar_status_n=0;
var groaner_jar_timer=0;


groaner_jar_status[0]=function(){
}


groaner_jar_status[1]=function(){
groaner_jar_timer+=delta;
if(groaner_jar_timer>2){
action["groaner_run"].stop();
action["groaner_jump"].play();
groaner_jar_timer=0;
groaner_jar_status_n=2;
}
}


groaner_jar_status[2]=function(){
groaner_jar_timer+=delta;
if(groaner_jar_timer>0.88){
action["groaner_jump"].stop();
action["groaner_run"].play();
groaner_jar_timer=0;
groaner_jar_status_n=3;
}
}


groaner_jar_status[3]=function(){
mesh["groaner_jump_and_run"].position.x+=delta*1;
}


trigger["groaner_jump_and_run"]=new THREE.Mesh(new THREE.BoxBufferGeometry(10,5,5),new THREE.MeshBasicMaterial({color:0xffff00}));
trigger["groaner_jump_and_run"].geometry.computeBoundingBox();
trigger["groaner_jump_and_run"].material.wireframe=true;
trigger["groaner_jump_and_run"].position.set(58,1.5,-100);
if(debug_mode){
scene.add(trigger["groaner_jump_and_run"]);
}
var min=trigger["groaner_jump_and_run"].geometry.boundingBox.min;
var max=trigger["groaner_jump_and_run"].geometry.boundingBox.max;
var position=trigger["groaner_jump_and_run"].position;
min.x+=position.x;
min.y+=position.y;
min.z+=position.z;
max.x+=position.x;
max.y+=position.y;
max.z+=position.z;
trigger["groaner_jump_and_run"].min_x=min.x;
trigger["groaner_jump_and_run"].min_y=min.y;
trigger["groaner_jump_and_run"].min_z=min.z;
trigger["groaner_jump_and_run"].max_x=max.x;
trigger["groaner_jump_and_run"].max_y=max.y;
trigger["groaner_jump_and_run"].max_z=max.z;
trigger["groaner_jump_and_run"].activated=0;


// ____________________ MUMBLER ____________________


other_to_load++;
FBXLoader.load('models/mumbler/mumbler.fbx',function(object){
mixer["mumbler"]=new THREE.AnimationMixer(object);
action["mumbler"]=THREE.AnimationUtils.subclip(object.animations[0],'attack',0,1000);
action["mumbler"]=mixer["mumbler"].clipAction(action["mumbler"]);
action["mumbler"].timeScale=0.5;
action["mumbler"].play();
mixers.push(mixer["mumbler"]);
mesh["mumbler"]=object;
mesh["mumbler"].children[1].material=new THREE.MeshBasicMaterial({map:tex["mumbler"]});
mesh["mumbler"].children[1].frustumCulled=false;
mesh["mumbler"].children[1].onAfterRender=function(){
this.frustumCulled=true;
this.onAfterRender=function(){};
}
mesh["mumbler"].position.set(133,-1.3,-7);
mesh["mumbler"].rotation.y=2.6;
mesh["mumbler"].scale.set(0.06,0.06,0.06);
// ÑÊĞÛÂÀÅÌ ÊÎÑÒÈ, ÑÍÈÆÀß ÍÀÃĞÓÇÊÓ ÍÀ 10%. ÏĞÈ İÒÎÌ ÄÎÑÒÀÒÎ×ÍÎ ÑÊĞÛÒÜ ÏÅĞÂÓŞ ÎÑÍÎÂÓÍÓŞ ÊÎÑÒÜ, ÎÑÒÀËÜÍÛÅ ÍÅÎÁßÇÀÒÅËÜÍÎ.
mesh["mumbler"].traverse(function(child){
if(child.isBone){ child.visible=false; }
});
scene.add(mesh["mumbler"]);
other_loaded++;
});


// ____________________ TOWN ____________________


var town_text="";


var town_obj_total=0;
var town_tris_total=0;
var town_tris_cell_c=0;
var town_tris_cell_n=0;
var town_tris_cell=[];
var town_tris_a=new Float32Array(10000000);
var town_tris_n=0;
var town_left=Infinity;
var town_right=-Infinity;
var town_top=Infinity;
var town_bottom=-Infinity;
var town_cell=[];
var town_children=[];
var town=new THREE.Group;
scene.add(town);


other_to_load++;


OBJLoader.load("models/town/town.obj",function(object){


var town_pre_cell=[];


while(object.children.length){


var name=object.children[0].name;
mesh[name]=object.children[0];
mesh[name].geometry.computeBoundingBox();
mesh[name].matrixAutoUpdate=false;
mesh[name].updateMatrixWorld=function(){};
mesh[name].frustumCulled=false;


mesh[name].onAfterRender=function(){
this.frustumCulled=true;
scene.remove(this);
this.onAfterRender=function(){};
}


// ____________________ ĞÀÇÁÈÂÀÅÌ ÃÎĞÎÄ ÍÀ ÑÅÊÒÎĞÀ Ñ ÎÁÚÅÊÒÀÌÈ ____________________


var item=mesh[name].geometry.boundingBox;
var bmin=item.min;
var bmax=item.max;
// ÎÊĞÓÃËßÅÌ ×ÅĞÅÇ floor ÂÅÇÄÅ, À ÍÅ ceil ÄËß ÏĞÀÂÎÉ ÑÒÎĞÎÍÛ È ceil ÄËß ÍÈÇÀ.
// ÏĞÈÌÅĞ: ĞÀÇÌÅĞ ÑÅÊÒÎĞÀ 50. ËÅÂÀß ÒÎ×ÊÀ 0, ÏĞÀÂÀß ÒÎ×ÊÀ 51.2. ÏĞÈ floor ÇÀÉÌ¨Ò ÑÅÊÒÎĞÀ 0 È 1
// ÅÑËÈ ÄËß ÏĞÀÂÎÉ ÒÎ×ÊÈ ÈÑÏÎËÜÇÎÂÀÒÜ ceil, ÒÎ ÇÀÉÌ¨Ò 0, 1 È 2, À İÒÎ ÓÆÅ ËÈØÍÅÅ. ÂÅÄÜ ØÈĞÈÍÀ ÂÑÅÃÎ 51.2, À İÒÎ ÍÈÊÀÊ ÍÅ 3 ÑÅÊÒÎĞÀ.
var left=Math.floor(bmin.x/town_cell_size);
var right=Math.floor(bmax.x/town_cell_size);
var top=Math.floor(bmin.z/town_cell_size);
var bottom=Math.floor(bmax.z/town_cell_size);


if(left<town_left){ town_left=left; }
if(right>town_right){ town_right=right; }
if(top<town_top){ town_top=top; }
if(bottom>town_bottom){ town_bottom=bottom; }


for(var x=left;x<=right;x++){
for(var z=top;z<=bottom;z++){
var cell_name=x+"_"+z;
if(town_pre_cell[cell_name]==undefined){ town_pre_cell[cell_name]=[]; }
town_pre_cell[cell_name].push(name);
}
}


// ____________________ ĞÀÇÁÈÂÀÅÌ ÃÎĞÎÄ ÍÀ ÑÅÊÒÎĞÀ Ñ ÒĞÅÓÃÎËÜÍÈÊÀÌÈ ____________________


var item=mesh[name].geometry.attributes.position.array;
var max=mesh[name].geometry.attributes.position.count*3;


town_obj_total++;
town_tris_total+=max/9;


for(var n=0;n<max;n+=9){


var left=Infinity;
var right=-Infinity;
var top=Infinity;
var bottom=-Infinity;


town_tris_a[town_tris_n]=item[n];
town_tris_a[town_tris_n+1]=item[n+1];
town_tris_a[town_tris_n+2]=item[n+2];
town_tris_a[town_tris_n+3]=item[n+3];
town_tris_a[town_tris_n+4]=item[n+4];
town_tris_a[town_tris_n+5]=item[n+5];
town_tris_a[town_tris_n+6]=item[n+6];
town_tris_a[town_tris_n+7]=item[n+7];
town_tris_a[town_tris_n+8]=item[n+8];


// ÏÅĞÂÀß ÒÎ×ÊÀ
if(item[n]<left){ left=item[n]; }
if(item[n]>right){ right=item[n]; }
if(item[n+2]<top){ top=item[n+2]; }
if(item[n+2]>bottom){ bottom=item[n+2]; }
// ÂÒÎĞÀß ÒÎ×ÊÀ
if(item[n+3]<left){ left=item[n+3]; }
if(item[n+3]>right){ right=item[n+3]; }
if(item[n+5]<top){ top=item[n+5]; }
if(item[n+5]>bottom){ bottom=item[n+5]; }
// ÒĞÅÒÜß ÒÎ×ÊÀ
if(item[n+6]<left){ left=item[n+6]; }
if(item[n+6]>right){ right=item[n+6]; }
if(item[n+8]<top){ top=item[n+8]; }
if(item[n+8]>bottom){ bottom=item[n+8]; }


// ÎÊĞÓÃËßÅÌ ×ÅĞÅÇ floor ÂÅÇÄÅ, À ÍÅ ceil ÄËß ÏĞÀÂÎÉ ÑÒÎĞÎÍÛ È ceil ÄËß ÍÈÇÀ.
// ÏĞÈÌÅĞ: ĞÀÇÌÅĞ ÑÅÊÒÎĞÀ 50. ËÅÂÀß ÒÎ×ÊÀ 0, ÏĞÀÂÀß ÒÎ×ÊÀ 51.2. ÏĞÈ floor ÇÀÉÌ¨Ò ÑÅÊÒÎĞÀ 0 È 1
// ÅÑËÈ ÄËß ÏĞÀÂÎÉ ÒÎ×ÊÈ ÈÑÏÎËÜÇÎÂÀÒÜ ceil, ÒÎ ÇÀÉÌ¨Ò 0, 1 È 2, À İÒÎ ÓÆÅ ËÈØÍÅÅ. ÂÅÄÜ ØÈĞÈÍÀ ÂÑÅÃÎ 51.2, À İÒÎ ÍÈÊÀÊ ÍÅ 3 ÑÅÊÒÎĞÀ.
left=Math.floor(left/town_tris_size);
right=Math.floor(right/town_tris_size);
top=Math.floor(top/town_tris_size);
bottom=Math.floor(bottom/town_tris_size);


for(var x=left;x<=right;x++){
for(var z=top;z<=bottom;z++){
var cell_name=x+"_"+z;
if(town_tris_cell[cell_name]==undefined){ town_tris_cell[cell_name]=[]; town_tris_cell_c++; }
town_tris_cell[cell_name].push(town_tris_n);
town_tris_cell_n++;
}
}


town_tris_n+=9;


}


scene.add(mesh[name]);


}


if(debug_mode){
document.getElementById("tris").innerHTML=town_obj_total+" Âñåãî òğåóãîëüíèêîâ: "+town_tris_total+" ß÷ååê òğåóã "+town_tris_cell_c+" Íîìåğîâ òğåóã "+town_tris_cell_n;
}


// ____________________ ÎÁÚÅÄÈÍßÅÌ ÎÁÚÅÊÒÛ ÍÀ ÑÅÊÒÎĞÅ Â ĞÀÄÈÓÑÅ 9 ÑÅÊÒÎĞÎÂ ____________________


for(var x=town_left-1;x<=town_right+1;x++){
for(var z=town_top-1;z<=town_bottom+1;z++){


var merge_name=x+"_"+z;
var found=0;


town_cell[merge_name]=[];
town_children[merge_name]=[];
var town_items_added_list=[];


for(var i=0;i<9;i++){


var cell_name=(x+ways_9[i][0])+"_"+(z+ways_9[i][1]);


if(town_pre_cell[cell_name]==undefined){ continue; }


found=1;
var max=town_pre_cell[cell_name].length;


for(var n=0;n<max;n++){


var item_name=town_pre_cell[cell_name][n];
if(town_items_added_list[item_name]==undefined){
town_cell[merge_name].push(town_pre_cell[cell_name][n]);
town_children[merge_name].push(mesh[town_pre_cell[cell_name][n]]);
town_items_added_list[item_name]=1;
}


}
}


// ÅÑËÈ ÂÎÊĞÓÃ ÍÈ×ÅÃÎ ÍÅÒ, ÒÎ ÓÄÀËßÅÌ, ×ÒÎÁÛ ÍÅ ÇÀÍÈÌÀËÎ ÏÀÌßÒÜ
if(found==0){
delete town_cell[merge_name];
delete town_children[merge_name]
}


}
}


other_loaded++;


});


// ____________________ ÎÒÎÁĞÀÆÀÅÌ ËÈØÜ ÍÓÆÍÛÅ ÎÁÚÅÊÒÛ ÍÀ 9 ÑÅÊÒÎĞÀÕ ____________________


/*
function town_objects2(){


for(var i=0;i<9;i++){


var cell_name=(camera_town_pre_x+ways_9[i][0])+"_"+(camera_town_pre_z+ways_9[i][1]);


if(town_cell[cell_name]==undefined){ continue; }


var max_objects=town_cell[cell_name].length;


for(var n=0;n<max_objects;n++){


scene.remove(mesh[town_cell[cell_name][n]]);


}


}


}


function town_objects_old(){


var max=objects_list.length;
for(var n=0;n<max;n++){
scene.remove(objects_list[n]);
}


var name=camera_town_pre_x+"_"+camera_town_pre_z;


if(town_cell[name]!=undefined){
var max=town_cell[name].length;
var item=[];
for(var n=0;n<max;n++){
item.push(mesh[town_cell[name][n]]);
scene.add(mesh[town_cell[name][n]]);
}
//scene.add(item);
objects_list=item;
}
else{
objects_list=[];
}


camera_town_x=camera_town_pre_x;
camera_town_z=camera_town_pre_z;


}


function town_objects77(){


var objects_new=[];


var town_cell_obj=town_cell[camera_town_pre_x+"_"+camera_town_pre_z];


if(town_cell_obj!=undefined){


var max=town_cell_obj.length;


for(var n=0;n<max;n++){


var name=town_cell_obj[n];
objects_new[name]=1;


if(objects_list[name]==undefined){
// ÄÎÁÀÂËßÅÌ ÍÀÏĞßÌÓŞ
scene_children.push(mesh[name]);
}
else{
delete objects_list[name];
}


}


}


for(var i in objects_list){
// ÓÄÀËßÅÌ ÍÀÏĞßÌÓŞ
scene_children.splice(scene_children.indexOf(mesh[i]),1);
}


objects_list=objects_new;


camera_town_x=camera_town_pre_x;
camera_town_z=camera_town_pre_z;


}


*/


function town_objects(){


var start=performance.now();
 
 
camera_town_pre_x=Math.floor(camera_position.x/town_cell_size);
camera_town_pre_z=Math.floor(camera_position.z/town_cell_size);


if(camera_town_x==camera_town_pre_x && camera_town_z==camera_town_pre_z){ return; }



var town_children_obj=town_children[camera_town_pre_x+"_"+camera_town_pre_z];


if(town_children_obj!=undefined){ town.children=town_children_obj; }
else{ town.children=[]; }


camera_town_x=camera_town_pre_x;
camera_town_z=camera_town_pre_z;


var end=(performance.now()-start).toFixed(3);


if(debug_mode){
var count=0;
if(town_children_obj!=undefined){ count=town_children_obj.length; }
document.getElementById("town").innerHTML="<font>["+count+"]</font> "+end;
}


}


// ____________________ ÑÍÅÃ ____________________


var snow_fall=[]; // ÌÀÑÑÈÂ ÏÀÄÀŞÙÈÕ ÑÍÅÆÈÍÎÊ
var snow_fall_radius_1=16; // Â ÊÀÊÎÌ ĞÀÄÈÓÑÅ ÎÒ ÖÅÍÒĞÀ ÊÀÌÅĞÛ ÑÎÇÄÀÂÀÒÜ ÑÍÅÆÈÍÊÈ
var snow_fall_radius_2=4; // Â ÊÀÊÎÌ ĞÀÄÈÓÑÅ ÂÛÁÈĞÀÒÜ ÍÀÏĞÀÂËÅÍÈÅ ÏÀÄÅÍÈß ÑÍÅÆÈÍÊÈ. ×ÅÌ ÌÅÍÜØÅ, ÒÅÌ ÌÅÍÜØÅ ÑÅÊÒÎĞÎÂ ÍÀÄÎ Ñ×ÈÒÀÒÜ
var snow_fall_top=3; // Ñ ÊÀÊÎÉ ÂÛÑÎÒÛ ÏÀÄÀŞÒ ÑÍÅÆÈÍÊÈ
var snow_fall_bottom=-5.0; // ÄÎ ÊÓÄÀ ÌÀÊÑÈÌÓÌ ÏÎ ÂÛÑÎÒÅ Â ÏĞÎÏÀÑÒÜ ÌÎÃÓÒ ÓÏÀÑÒÜ ÑÍÅÆÈÍÊÈ
var snow_fall_speed=5; // ÑÊÎĞÎÑÒÜ ÏÀÄÅÍÈß ÌÅÒĞÎÂ Â ÑÅÊÓÍÄÓ
var snow_fall_offset=0.02; // ÍÀ ÑÊÎËÜÊÎ ÌÅÒĞÎÂ ÎÒÎÄÂÈÃÀÒÜ ÑÍÅÆÈÍÊÓ ÎÒ ÏÎÂÅĞÕÍÎÑÒÈ
var snow_add_m=0; // 0 - ÍÅ ÄÎÁÀÂËßÒÜ ÑÍÅÃ, 1 - ÄÎÁÀÂËßÒÜ
var snow_add_time=0.002; // ×ÅĞÅÇ ÑÊÎËÜÊÎ ÌÈËÈÑÅÊÓÍÄ ÄÎÁÀÂËßÒÜ ÍÎÂÓŞ ÑÍÅÆÈÍÊÓ
var snow_add_time_n=0; // ÍÅ ÌÅÍßÒÜ
var snow_fade=[]; // ÌÀÑÑÈÂ ÓÏÀÂØÈÕ ÑÍÅÆÈÍÎÊ
var snow_fade_time=1.5; // ×ÅĞÅÇ ÑÊÎËÜÊÎ ÑÅÊÓÍÄ ÓÄÀËßÒÜ ÓÏÀÂØÓŞ ÑÍÅÆÈÍÊÓ


vs["snow_fall"]=`


varying float fogDepth;


void main(){


vec4 mvPosition=modelViewMatrix*vec4(position,1.0);
fogDepth=-mvPosition.z;
gl_PointSize=(100.0/fogDepth);
gl_Position=projectionMatrix*mvPosition;


}`;


fs["snow_fall"]=`


uniform sampler2D map;
varying float fogDepth;
float fogDensity=-0.14*0.14;
vec3 fogColor=vec3(0.5411,0.4941,0.6078);


void main(){


gl_FragColor=texture2D(map,gl_PointCoord);
if(gl_FragColor.a<0.02){ discard; }
float fogFactor=1.0-exp(fogDensity*fogDepth*fogDepth);
gl_FragColor.rgb=mix(gl_FragColor.rgb,fogColor,fogFactor);


}`;


mat["snow_fall"]=new THREE.ShaderMaterial({
uniforms:{
map:{value:tex["snow"]}
},
vertexShader:vs["snow_fall"],
fragmentShader:fs["snow_fall"],
transparent:true,
});


var geometry=new THREE.BufferGeometry();
geometry.setAttribute("position",new THREE.BufferAttribute(new Float32Array(),3));
mesh["snow_fall"]=new THREE.Points(geometry,mat["snow_fall"]);
mesh["snow_fall"].matrixAutoUpdate=false;
mesh["snow_fall"].updateMatrixWorld=function(){};
mesh["snow_fall"].frustumCulled=false;
scene.add(mesh["snow_fall"]);


vs["snow_fade"]=`


precision highp float;
attribute vec4 position;
varying float fogDepth;
varying float vFade;
uniform mat4 modelViewMatrix;
uniform mat4 projectionMatrix;


void main(){


vFade=position.w;
vec4 mvPosition=modelViewMatrix*vec4(position.xyz,1.0);
fogDepth=-mvPosition.z;
gl_PointSize=(100.0/fogDepth);
gl_Position=projectionMatrix*mvPosition;


}`;


fs["snow_fade"]=`


precision highp float;
uniform sampler2D map;
varying float fogDepth;
varying float vFade;
float fogDensity=-0.14*0.14;
vec3 fogColor=vec3(0.5411,0.4941,0.6078);


void main(){


gl_FragColor=texture2D(map,gl_PointCoord);
if(gl_FragColor.a<0.02){ discard; }
float fogFactor=1.0-exp(fogDensity*fogDepth*fogDepth);
gl_FragColor.rgb=mix(gl_FragColor.rgb,fogColor,fogFactor);
gl_FragColor.a*=vFade;


}`;


mat["snow_fade"]=new THREE.RawShaderMaterial({
uniforms:{
map:{value:tex["snow"]},
modelViewMatrix:{value:camera.projectionMatrix},
projectionMatrix:{value:camera.projectionMatrix},
},
vertexShader:vs["snow_fade"],
fragmentShader:fs["snow_fade"],
transparent:true,
});


var geometry=new THREE.BufferGeometry();
geometry.setAttribute("position",new THREE.BufferAttribute(new Float32Array(),4));
mesh["snow_fade"]=new THREE.Points(geometry,mat["snow_fade"]);
mesh["snow_fade"].matrixAutoUpdate=false;
mesh["snow_fade"].updateMatrixWorld=function(){};
mesh["snow_fade"].frustumCulled=false;
scene.add(mesh["snow_fade"]);


// ____________________ ÄÎÁÀÂËÅÍÈÅ ÑÍÅÃÀ ____________________


function snow_add(){


// ×ÒÎÁÛ ÑÎÇÄÀÒÜ ÊÎÎĞÄÈÍÀÒÛ ÎÒÊÓÄÀ ÁÓÄÅÒ ÏÀÄÀÒÜ ÑÍÅÃ,
// ÂÎÊĞÓÃ ÊÀÌÅĞÛ ÑÎÇÄÀ¨Ì ÎÊĞÓÆÍÎÑÒÜ Ñ ÍÀØÈÌ ĞÀÄÈÓÑÎÌ È ÂÛÁÈĞÀÅÌ ÍÀ ÍÅÉ ÑËÓ×ÀÉÍÛÅ ÊÎÎĞÄÈÍÀÒÛ X È Z. À ÂÛÑÎÒÓ ÑÒÀÂÈÌ ÑÂÎŞ
var radius_1=snow_fall_radius_1*Math.sqrt(Math.random());
var theta=2*Math.PI*Math.random();
var x_1=camera_position.x+radius_1*Math.cos(theta);
var y_1=snow_fall_top;
var z_1=camera_position.z+radius_1*Math.sin(theta);


// ÂÎÊĞÓÃ ÂÛÁĞÀÍÍÛÕ 2D ÊÎÎĞÄÈÍÀÒ ÑÎÇÄÀ¨Ì ÅÙ¨ ÎÄÈÍ ĞÀÄÈÓÑ È ÏÎÄÍÈÌÀÅÌÑß Â ÍÅÁÎ


var radius_2=snow_fall_radius_2*Math.sqrt(Math.random());
var theta=2*Math.PI*Math.random();
var x_2=x_1+radius_2*Math.cos(theta);
var y_2=snow_fall_bottom;
var z_2=z_1+radius_2*Math.sin(theta);


// ÑÎÇÄÀ¨Ì 3D ÂÅÊÒÎĞ Ê ÍÀÉÄÅÍÍÛÌ 2D ÊÎÎĞÄÈÍÀÒÀÌ, ÄÎÁÀÂÈÂ ÊÎÎĞÄÈÍÀÒÓ ÂÛÑÎÒÛ
direction_x=x_2-x_1;
direction_y=y_2-y_1;
direction_z=z_2-z_1;


// ÍÎĞÌÀËÈÇÓÅÌ ÂÅÊÒÎĞ
var divide=1/Math.sqrt(direction_x*direction_x+direction_y*direction_y+direction_z*direction_z);
direction_x*=divide;
direction_y*=divide;
direction_z*=divide;


// ÍÀÕÎÄÈÌ ÏÅĞÅÑÅ×ÅÍÈß ÏÎ ÑÅÊÒÎĞÀÌ


direction_2d_x=x_2-x_1;
direction_2d_z=z_2-z_1;


var divide=1/Math.sqrt(direction_2d_x*direction_2d_x+direction_2d_z*direction_2d_z);
direction_2d_x*=divide;
direction_2d_z*=divide;


origin_x=x_1;
origin_y=snow_fall_top;
origin_z=z_1;
distance=snow_fall_radius_2;


var result=cells_find();
if(result!=0){ result-=snow_fall_offset; x_2=origin_x+direction_x*result; y_2=origin_y+direction_y*result; z_2=origin_z+direction_z*result; }


// ÍÀ×ÀËÜÍÀß ÏÎÇÈÖÈß, ÊÎÍÅ×ÍÀß ÏÎÇÈÖÈß, ÂÅÊÒÎĞ ÑÊÎĞÎÑÒÈ, ÑÊÎËÜÊÎ ÏĞÎØËÎ ÌÈËËÈÑÅÊÓÍÄ Ñ ÌÎÌÅÍÒÀ ÑÎÇÄÀÍÈß
snow_fall.push([x_1,y_1,z_1,x_2,y_2,z_2,direction_x*snow_fall_speed,direction_y*snow_fall_speed,direction_z*snow_fall_speed,0]);


}


// ____________________ ÏÀÄÅÍÈÅ ÑÍÅÃÀ ____________________


function snow_fall_update(){


var max=snow_fall.length;
var alive=new Array(max);
var pre=new Float32Array(max*3);
var i=0;
var j=0;


for(var n=0;n<max;n++){


var item=snow_fall[n];
item[9]+=delta;
var t=item[9];
var y=item[1]+item[7]*t;


// ÅÑËÈ ÑÍÅÃ ÊÎÑÍÓËÑß ÏÎÂÅĞÕÍÎÑÒÈ, ÒÎ ÓÄÀËßÅÌ ÅÃÎ ÈÇ ÌÀÑÑÈÂÀ ÏÀÄÀŞÙÅÃÎ ÑÍÅÃÀ È ÄÎÁÀÂËßÅÌ Â ÌÀÑÑÈÂ ËÅÆÀÙÅÃÎ ÑÍÅÃÀ
// ÇÄÅÑÜ ÄËß ÓÄÀËÅÈß ÍÅ ÈÑÏÎËÜÇÓÅÌ now.splice(n,1); n--; max--; ÏÎÒÎÌÓ ÍÎÌÅĞÀ İËÅÌÅÍÒÎÂ ÏÅĞÅÍÓÌÅĞÓŞÒÑß È ÎÒÍÈÌÀÅÒ ÂĞÅÌß. ÁÛÑÒĞÅÅ ÁÓÄÅÒ ÊÀÆÄÛÉ ĞÀÇ ÏÅĞÅÑÎÇÄÀÂÀÒÜ ÌÀÑÑÈÂ
// ÏĞÈ 5000 İËÅÌÅÍÒÎÂ splice ÑĞÀÁÎÒÀÅÒ 5000 ĞÀÇ È ÇÀÉÌ¨Ò 42ÌÑ, À ÏÅĞÅÑÎÇÄÀÍÈÅ ÌÀÑÑÈÂÀ alive.push(item); ÂÑÅÃÎ 0.12ÌÑ, ×ÒÎ Â 350 ĞÀÇ ÁÛÑÒĞÅÅ
// ÅÑËÈ Â ÌÀÑÑÈÂÅ ÂÑÅÃÎ ÎÄÈÍ ĞÀÇ ÇÀÄÅÉÑÒÂÓÅÒÑß splice, ÒÎ ÅÙ¨ ÍÎĞÌÀËÜÍÎ, ÍÎ ÒÀÊ ÊÀÊ ÌÎÆÅÒ ÓÄÀËÈÒÑß 3-5 ÑÍÅÆÈÍÎÊ, ÒÎ İÒÎ ÓÆÅ ÒĞÀÒÀ ÄĞÀÃÎÖÅÍÍÎÃÎ ÂĞÅÌÅÍÈ


if(y>item[4]){
alive[i]=item;
i++;
pre[j]=item[0]+item[6]*t;
pre[j+1]=y;
pre[j+2]=item[2]+item[8]*t;
j+=3;
}
else{
snow_fade.push([item[3],item[4],item[5],snow_fade_time]);
}


}


alive.length=i;
snow_fall=alive;


mesh["snow_fall"].geometry.attributes.position=new THREE.BufferAttribute(pre,3);


}


// ____________________ ÓÂßÄÀÍÈÅ ÑÍÅÃÀ ____________________


function snow_fade_update(){


var max=snow_fade.length;
var alive=new Array(max);
var pre=new Float32Array(max*4);
var i=0;
var j=0;


for(var n=0;n<max;n++){


var item=snow_fade[n];
item[3]-=delta;
var t=item[3];


if(t>0){
alive[i]=item;
i++;
pre[j]=item[0];
pre[j+1]=item[1];
pre[j+2]=item[2];
pre[j+3]=t/snow_fade_time;
j+=4;
}


}


alive.length=i;
snow_fade=alive;


mesh["snow_fade"].geometry.attributes.position=new THREE.BufferAttribute(pre,4);


// ÓÑÒÀÍÀÂËÈÂÀÅÌ ÄÈÍÀÌÈ×ÍÎÑÒÜ, ×ÒÎÁÛ ÍÅ ÁÛËÎ ÑÊÀ×ÊÎÂ FPS ÏĞÈ ÓÄÀËÅÍÈÈ ÌÓÑÎĞÀ Â ÎÇÓ


mesh["snow_fade"].geometry.attributes.position.setUsage(THREE.DynamicDrawUsage);


}


// ____________________ ĞÀÄÈÓÑ ÑÍÅÃÀ ____________________


if(debug_mode){


var circleRadius=snow_fall_radius_1;
var circleShape=new THREE.Shape().moveTo(0,circleRadius)
.quadraticCurveTo(circleRadius,circleRadius,circleRadius,0)
.quadraticCurveTo(circleRadius,-circleRadius,0,-circleRadius)
.quadraticCurveTo(-circleRadius,-circleRadius,-circleRadius,0)
.quadraticCurveTo(-circleRadius,circleRadius,0,circleRadius);
circleShape.autoClose=true;


var points=circleShape.getPoints();
var max=points.length;
// ÏÅĞÅÂÎĞÀ×ÈÂÀÅÌ
for(var n=0;n<max;n++){
points[n].z=points[n].y;
points[n].y=0;
}
var geometry=new THREE.BufferGeometry().setFromPoints(points);


mesh["snow_circle"]=new THREE.Line(geometry,new THREE.LineBasicMaterial({color:0xffffff}));
mesh["snow_circle"].frustumCulled=false;
mesh["snow_circle"].position.x=camera_position.x;
mesh["snow_circle"].position.y=-1;
mesh["snow_circle"].position.z=camera_position.z;
scene.add(mesh["snow_circle"]);


}


// ____________________ ĞÅÍÄÅĞÈÍÃ ____________________


var go=0;


function loop(){


requestAnimationFrame(loop);


delta=clock.getDelta();


if(slow_down==1){
if(slow_v>0.002){ slow_v-=0.0001; }
delta=slow_v;
}


if(slow_up==1){
slow_down=0;
if(slow_v<0.016){ slow_v+=0.0001; }
if(slow_v>0.015){ slow_v=0.016; slow_up=0; }
delta=slow_v;
}


// ĞÀÑ×ÈÒÛÂÀÅÌ ÏÅĞÅÄ ÒÀÉÌÅĞÀÌÈ, ×ÒÎÁÛ ÍÅ Ó×ÈÒÛÂÀËÎÑÜ Â ÎÁÙÅÌ ÂĞÅÌÅÍÈ ÑÒÀÒÈÑÒÈÊÈ
if(debug_mode){ stats.update(); }


debug["javascript"].start=performance.now();
debug["frame"].start=performance.now();
debug_fps_elapsed+=delta;
if(debug_fps_elapsed>0.5){ debug_fps_elapsed=0; debug_fps_now=(1000/(performance.now()-debug_fps_last)).toFixed(2); }
debug_fps_last=performance.now();


if(stop==1){ return; }


logo_status[logo_status_n]();


if(debug_mode){
mesh["snow_circle"].position.x=camera_position.x;
mesh["snow_circle"].position.z=camera_position.z;
}


// ____________________ ÄÎÁÀÂËÅÍÈÅ ÑÍÅÃÀ ____________________


// ÏÅĞÂÛÌ ÈÄ¨Ò ÄÎÁÀÂËÅÍÈÅ ÑÍÅÃÀ, À ÇÀÒÅÌ ÏÀÄÅÍÈÅ, ×ÒÎÁÛ ÑÎÇÄÀÍÍÛÅ ÑÍÅÆÈÍÊÈ ÓÑÏÅËÈ ÏĞÎËÅÒÅÒÜ ÍÓÆÍÎÅ ĞÀÑÑÒÎßÍÈÅ ÍÀ ÑËÓ×ÀÉ ÍÈÇÊÎÃÎ FPS, ÇÀÂÈÑÀÍÈß


debug["snow_add"].start=performance.now();


var add=0;


if(snow_add_m==1){


snow_add_time_n+=delta;
add=Math.floor(snow_add_time_n/snow_add_time);
snow_add_time_n-=add*snow_add_time;
// ÅÑËÈ ÑÈËÜÍÎÅ ÇÀÂÈÑÀÍÈÅ
if(add>0.016/snow_add_time*60*2){ snow_add_time_n=0; add=0; }


while(add--){
snow_add();
}


}


debug_calc("snow_add",add);


// ____________________ ÏÀÄÅÍÈÅ ÑÍÅÃÀ ____________________


debug["snow_fall"].start=performance.now();


snow_fall_update();


debug_calc("snow_fall",snow_fall.length);


// ____________________ ÓÂßÄÀÍÈÅ ÑÍÅÃÀ ____________________


debug["snow_fade"].start=performance.now();


snow_fade_update();


debug_calc("snow_fade",snow_fade.length);


// ____________________ ÎÒÎÁĞÀÆÀÅÌ ËÈØÜ ÍÓÆÍÛÅ ÎÁÚÅÊÒÛ ÍÀ 9 ÑÅÊÒÎĞÀÕ ____________________


town_objects();


if(go==1){


controls.update(delta);


if(camera_position.y<camera_bottom){ camera_position.y=camera_bottom; }
if(camera_position.y<camera_min_height){ camera_position.y+=(camera_min_height-camera_position.y)*0.02; }
if(camera_position.y>camera_top){ camera_position.y=camera_top; }
if(camera_position.y>camera_max_height){ camera_position.y-=(camera_position.y-camera_max_height)*0.02; }


debug["animations"].start=performance.now();


var max=mixers.length;


for(var n=0;n<max;n++){
mixers[n].update(delta);
}


debug_calc("animations",max);


mesh["Harry_Mason"].position.z=-240+(action["Harry_Mason"]._loopCount)*mesh["Harry_Mason"].distance;


if(trigger["air_screamer"].activated==0 &&
camera_position.x>=trigger["air_screamer"].min_x && camera_position.x<=trigger["air_screamer"].max_x &&
camera_position.y>=trigger["air_screamer"].min_y && camera_position.y<=trigger["air_screamer"].max_y &&
camera_position.z>=trigger["air_screamer"].min_z && camera_position.z<=trigger["air_screamer"].max_z
){
trigger["air_screamer"].activated=1;
}


if(trigger["air_screamer"].activated==1){


mesh["air_screamer"].position.x+=0.015;


var height=Math.sin(clock.elapsedTime*5);
if(height<0){ height/=200; }
else{
height/=26;
}
mesh["air_screamer"].position.y+=height;


}


if(trigger["groaner_jump_and_run"].activated==0 &&
camera_position.x>=trigger["groaner_jump_and_run"].min_x && camera_position.x<=trigger["groaner_jump_and_run"].max_x &&
camera_position.y>=trigger["groaner_jump_and_run"].min_y && camera_position.y<=trigger["groaner_jump_and_run"].max_y &&
camera_position.z>=trigger["groaner_jump_and_run"].min_z && camera_position.z<=trigger["groaner_jump_and_run"].max_z
){
trigger["groaner_jump_and_run"].activated=1;
groaner_jar_status_n=1;
}


if(trigger["groaner_jump_and_run"].activated==1){


mesh["groaner_jump_and_run"].position.z-=delta*5;


groaner_jar_status[groaner_jar_status_n]();


}


}


// ÑÒÀÂÈÌ ËÎÃÎÒÈÏ ÍÀÏĞÎÒÈÂ ÊÀÌÅĞÛ
camera.updateMatrixWorld();
mesh["logo"].matrixWorld.multiplyMatrices(camera.matrixWorld,mesh["logo"].matrix);


debug_calc("javascript");
debug["renderer"].start=performance.now();


renderer.clear(); // Î×ÈÙÀÅÌ ÏÎËÍÎÑÒÜŞ
renderer.render(scene,camera); // ÎÑÍÎÂÍÀß ÑÖÅÍÀ
if(debug_mode){ renderer_stats_update(0); }
renderer.clearDepth(); // ÓÁÈĞÀÅÌ ÃËÓÁÈÍÓ ÎÒ ÏĞÎØËÎÉ ÑÖÅÍÛ, ÒÎ ÅÑÒÜ ËÈØÍÅÅ
renderer.render(scene_hud,camera_hud); // HUD ÑÖÅÍÀ
if(debug_mode){ renderer_stats_update(1); }


debug_calc("renderer");
debug_calc("frame",debug_fps_now);


var max=debug_text.length;
for(var n=0;n<max;n++){
var item=debug_text[n];
debug[item[0]].element.innerHTML=item[1];
}
debug_text=[];


}


</script>
</body>
</html>
